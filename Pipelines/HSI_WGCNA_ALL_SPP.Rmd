---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library("genefilter")
library("DESeq2")
library("RColorBrewer")
library("WGCNA")
library("flashClust")
library("gridExtra")
library("ComplexHeatmap")
library("goseq")
library("dplyr")
library("clusterProfiler")
library("pheatmap")
library("magrittr")
library("dendsort")
#library("goodGenes")
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")
library("devtools")
library("tidyr")
```

```{r}
options(scipen = 999)
data <-read.csv("All_Species_Untargeted_Metabolites.csv", header = TRUE)
metadata <- read.csv("Metadata_All_Species.csv")
```


```{r}
# check for zero values
rowSums(dplyr::count(data)) > 0

# Gene filtering 
filt <- filterfun(pOverA(0.04,0.01)) # goes for like 4 ruled out or whatever

#create filter for the counts data
gfilt <- genefilter(data, filt)

#identify genes to keep by count filter
keep <- data[gfilt,]

#identify gene lists
n.keep <- rownames(keep)

#gene count data filtered in PoverA, P percent of the samples have counts over A
data_filt <- as.data.frame(data[which(rownames(data) %in% n.keep),])

#How many rows do we have before and after filtering?
nrow(data) #Before
nrow(data_filt) #Afte

# all worked out fine

```


```{r}
all(rownames(metadata$sample_id) %in% colnames(data_filt))
all(rownames(metadata$sample_id) == colnames(data_filt))

# Returns true
# Run code to look for outlier
sampleTree = hclust(dist(data_filt), method = "average");
plot(sampleTree, main = "Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)
```


```{r}
# go back to widht based orientation 
data_filt <- as.data.frame(t(data_filt))

#data_filt <- as.data.frame(apply(data_filt, 2, function(x) format(x, scientific = FALSE)))
# right so I need to fix the row column names 

colnames(data_filt) <- unlist(data_filt[1, ])
data_filt <- data_filt[-1, ]
# look for outliers in tree based on samples 
SampleTree = hclust(dist(data_filt), method = "average");
plot(sampleTree, main = "Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)


```


```{r}
allowWGCNAThreads(20)

powers <- c(c(1:20), seq(from = 12, to=20, by=2)) #Create a string of numbers from 1 through 10, and even numbers from 10 through 20
# 
# # Call the network topology analysis function
sft <-pickSoftThreshold(data_filt, powerVector = powers, verbose = 5)


# pLot out softthreading 
sizeGrWindow(9, 5)
par(mfrow = c(1,2));
cex1 = 0.9;
# # # Scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
     main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     labels=powers,cex=cex1,col="red");
# # # this line corresponds to using an R^2 cut-off
abline(h=0.8,col="red")
# # # Mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5],
     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
     main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")

```


### Set power as 6

```{r}
picked_power = 6
temp_cor <- cor
datExpr <- data_filt
cor <- WGCNA::cor     # Force it to use WGCNA cor function (fix a namespace conflict issue)
netwk <- blockwiseModules(datExpr,                         # <= input here
                          # == Adjacency Function ==
                          power = picked_power,               # <= power here
                          networkType = "signed",
                          
                          # == Tree and Block Options ==
                          deepSplit = 2,
                          pamRespectsDendro = F,
                          # detectCutHeight = 0.75,
                          minModuleSize = 20,                  
                          maxBlockSize = 10000,
                          
                          # == Module Adjustments ==
                          reassignThreshold = 0,
                          mergeCutHeight = 0.25,
                          
                          # == TOM == Archive the run results in TOM file (saves time) but it doesn't save a file
                          saveTOMs = F,
                          saveTOMFileBase = "ER",
                          
                          # == Output Options
                          numericLabels = F,
                          verbose = 3)

cor <- temp_cor     # Return cor function to original nam



```
```{r}
mergedColors = netwk$colors
# Plot the dendrogram and the module colors underneath
#pdf("blockwise_module_colors.pdf")
plot <- plotDendroAndColors(
  netwk$dendrograms[[1]],
  mergedColors[netwk$blockGenes[[1]]],
  "Module colors",
  dendroLabels = FALSE,
  hang = 0.03,
  addGuide = TRUE,
  guideHang = 0.05 )


table(mergedColors)
plot

```



```{r}
module_df <- data.frame(
  Metabolite = names(netwk$colors),
  colors = labels2colors(netwk$colors))
```






```{r}
MEs <- moduleEigengenes(data_filt, mergedColors)$eigengenes

# Reorder modules so similar modules are next to each other
MEs <- orderMEs(MEs)
module_order = names(MEs) %>% gsub("ME","", .)

# Add Sample names
MEs0 <- MEs
MEs0$Sample.ID = row.names(MEs)

# tidy & plot data
mME = MEs0 %>%
  pivot_longer(-Sample.ID) %>%
  mutate(
    name = gsub("ME", "", name),
    name = factor(name, levels = module_order)
  )

mME %>% ggplot(., aes(x=Sample.ID, y=name, fill=value)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1,1)) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(title = "Module-Sample Relationships", y = "Modules", fill="corr")


```


```{r}
metadata$num <- c("1")
allTraits <- as.data.frame(pivot_wider(metadata, names_from = Treatment, values_from = num, id_cols = Sample.ID))
allTraits[is.na(allTraits)] <- c("0")
rownames(allTraits) <- allTraits$Sample
datTraits <- allTraits[,c(-1)]
head(datTraits)

#define numbers of metabolites and samples and view 
nMetabolites = ncol(data_filt)
nSamples = nrow(data_filt)

```


```{r}
moduleTraitCor = cor(MEs, datTraits, use = "p");
moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples);
Colors=sub("ME","", names(MEs))
moduleTraitTree = hclust(dist(t(moduleTraitCor)), method = "average")
 # error
pdf(file="moduleTraitTree.pdf", width = 14, height = 10)
plot(moduleTraitTree)
#dev.off()
```
IDK what this code does

```{r}
textMatrix = paste(signif(moduleTraitCor, 2), "\n(",signif(moduleTraitPvalue, 1), ")", sep = "")
dim(textMatrix) = dim(moduleTraitCor)
head(textMatrix)
labeledHeatmap(Matrix = moduleTraitCor, xLabels = names(datTraits_merged),  yLabels = names(MEs), ySymbols = names(MEs), cex.lab.y= 0.55, cex.lab.x= 0.55, colors = blueWhiteRed(50), textMatrix = textMatrix, setStdMargins = TRUE, cex.text = 0.25, textAdj = , zlim = c(-1,1), main = paste("Module-trait relationships"))
labeledHeatmap(Matrix = moduleTraitCor, xLabels = names(datTraits_merged),  yLabels = names(MEs), ySymbols = names(MEs), cex.lab.y= 0.55, cex.lab.x= 0.55, colors = blueWhiteRed(50), textMatrix = textMatrix, setStdMargins = TRUE, cex.text = 0.25, textAdj = , zlim = c(-1,1), main = paste("Module-trait relationships"))
pdf(file="Module-trait-relationships.pdf")

```


```{r}
#dendrogram with WGCNA MEtree cut-off
#colored y-axis
#Create list of pvalues for eigengene correlation with specific life stages
heatmappval <- signif(moduleTraitPvalue, 1)
#Make list of heatmap row colors
htmap.colors <- names(MEs)
htmap.colors <- gsub("ME", "", htmap.colors)

row_dend = dendsort(hclust(dist(moduleTraitCor)))
col_dend = dendsort(hclust(dist(t(moduleTraitCor))))

#row_ha = rowAnnotation(ModuleSize = anno_text("11", "127", "8", "64", "85"), just = "left", 
#        location = unit(0.5, "npc"), show_name = TRUE)
# brown (11), grey (127), yellow (8), blue (64), turqoise (85) #figure out how to do row annotations to add sample sizes

#All samples#lifestage_order <- c("T0_Ambient_Acropora", "T1_Ambient_Acropora", "T2_Ambient_Acropora", "T0_Hot_Acropora", "T1_Hot_Acropora", "T2_Hot_Acropora","T0_Ambient_Porites","T1Ambient_Porites","T2_Ambient_Porites","T0_Hot_Porites","T1_Hot_Porites","T2_Hot_Porites", "T0_Ambient_Stylophora", "T1_Ambient_Stylophora", "T0_Hot_Stylophora", "T1_Hot_Stylophora"  )

# All Species 
# lifestage_order <- c("Acropora", "Porites", "Stylophora")

# Time point
#lifestage_order <- c("T0", "T1", "T2")

# Treatment
lifestage_order <- c("Ambient", "Hot")


#cluster by similarity 

#pdf(file = "Mcap2020/Figures/Metabolomics/WGCNA/Module-trait-relationship-heatmap.pdf", height = 8, width = 8)
ht=Heatmap(moduleTraitCor, name = "Eigengene", column_title = "Module-Group Eigengene Correlation", 
        col = blueWhiteRed(50), 
        row_names_side = "left", 
        row_dend_side = "left",
        width = unit(10, "in"), 
        height = unit(4, "in"), 
        column_dend_reorder = TRUE, 
        cluster_columns = col_dend,
        row_dend_reorder = FALSE,
        #column_split = 4, 
        row_split = 3, 
        #column_dend_height = unit(.5, "in"),
        cluster_rows = row_dend, 
        #column_order = lifestage_order, # note this needs to be added)
        row_gap = unit(2.5, "mm"), 
        border = TRUE,
        cell_fun = function(j, i, x, y, w, h, col) {
        if(heatmappval[i, j] < 0.05) {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
        }
        else {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
        }},
        column_names_rot = 90,
        column_names_gp =  gpar(fontsize = 12, border=FALSE),
        row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE))

#pdf(file="heatmap_treatment.pdf", width = 14, height = 10)
plot(ht)
#dev.off()
```


############ Try exporting the dataset ####################

```{r}
time_point <- as.data.frame(as.numeric(as.factor(paste(sep=".", metadata$Treatment_Time_Species))))
names(time_point) = "timepoint"
dim(time_point)
```


```{r}

modNames = substring(names(MEs), 3)

#bicor
# datTraits
geneModuleMembership = as.data.frame(cor(datExpr, MEs, use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));

names(geneModuleMembership) = paste("MM", modNames, sep="");
names(MMPvalue) = paste("p.MM", modNames, sep="");

geneTraitSignificance = as.data.frame(cor(datExpr, data.frame(lapply(datTraits, as.numeric), stringsAsFactors = F), use = "p"));
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));




names(geneTraitSignificance) = paste("GS.", names(time_point), sep="");
names(GSPvalue) = paste("p.GS.", names(time_point), sep="");
```


```{r}
probes = names(datExpr)
```

```{r}
geneInfo0 = data.frame(gene_id = probes,
#Accession = Mcap.annot$description[probes2annot],
#Bitscore = Mcap.annot$bitscore[probes2annot],
#eValue = Mcap.annot$eValue[probes2annot],
#Description = Mcap.annot$protein_names[probes2annot],
#KEGG = Mcap.annot$ko[probes2annot],
#Annotation.GO.ID = Mcap.annot$GO_IDs[probes2annot],
#Annotation.GO.Term = Mcap.annot$GO_terms[probes2annot],
moduleColor = mergedColors,
geneTraitSignificance,
GSPvalue)


```



```{r}
modOrder = order(-abs(cor(MEs, time_point, use = "p")))

for (mod in 1:ncol(geneModuleMembership))
{
oldNames = names(geneInfo0)
geneInfo0 = data.frame(geneInfo0, geneModuleMembership[, modOrder[mod]],
MMPvalue[, modOrder[mod]]);
names(geneInfo0) = c(oldNames, paste("MM.", modNames[modOrder[mod]], sep=""),
paste("p.MM.", modNames[modOrder[mod]], sep=""))
}


geneOrder = order(geneInfo0$moduleColor);
geneInfo = geneInfo0[geneOrder, ]
head(geneInfo)


write.csv(geneInfo, file = "geneInfo.csv")

```




# big time mess up. 
# Meh ceebs for now

```{r}
modules_of_interest = c("royalblue", "black", "yellow", "magenta", "turquoise", "brown", "tan", "blue", "grey60")

submod = module_df %>%
  subset(colors %in% modules_of_interest)


#row.names(module_df) = module_df$Metabolite


submod_df = data.frame(submod) %>%
  mutate(
    Metabolite = row.names(.)
  ) %>%
  pivot_longer(-Metabolite) %>%
  mutate(
    module = module_df[Metabolite,]$colors
  )



submod_df %>% ggplot(., aes(x=name, y=value, group=Metabolite)) +
  geom_line(aes(color = module),
            alpha = 0.2) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  facet_grid(rows = vars(module)) +
  labs(x = "treatment",
       y = "normalized expression")


```

```{r}
row_mod_num <- data.frame(table(module_df$colors)) 

# Bring in additional metadata

metadata$Sample.ID <- as.factor(metadata$Sample.ID)
metadata$Timepoint <- as.factor(metadata$Time.Point)
metadata$Treatment <- as.factor(metadata$Treatment)


mME_meta <- merge(mME, metadata, by = "Sample.ID")


```

```{r}
expression_plots_cluster<-mME_meta%>%
#  group_by(Module) %>%
  ggplot(aes(x=lifestage, y=value)) +
  facet_grid(~module)+
  ylab("Eigengene Expression") +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")+
  geom_point(aes(fill=group, color=group), size=3, pch = 21, position = position_dodge(width = 0.5)) +
  geom_smooth(aes(group=1), se=TRUE, show.legend = NA, color="black")+
  xlab("") + #Axis titles
  theme_bw() + theme(panel.border = element_rect(color="black", fill=NA, size=0.75), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_blank()) +
  theme(axis.text = element_text(size = 11 , color = "black"),
        axis.title = element_text(size = 16, color = "black", face="bold"), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        legend.position="bottom", 
        legend.title=element_text(size=12, face="bold"), 
        legend.text=element_text(color="black", size=12), 
        strip.text.x = element_text(size = 14, color = "black", face="bold"), 
        strip.background = element_rect(color="white", fill="white")); expression_plots_cluster
```
